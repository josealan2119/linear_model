name: ModelOps Deploy Test

on:
  push:
    branches: [ master ]   # o master, si esa es tu rama principal
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    container: josealan2119/aiops:latest

    steps:
      # 1Ô∏è‚É£ Descargar el c√≥digo
      - name: Checkout repository
        uses: actions/checkout@v2

      # 2Ô∏è‚É£ Mostrar mensaje de inicio
      - name: Hello world
        run: echo "üöÄ Iniciando workflow ModelOps Deploy Test..."

      # 3Ô∏è‚É£ Instalar dependencias
      - name: Install dependencies
        run: |
          python --version
          pip install -r requirements.txt

      # 4Ô∏è‚É£ Ejecutar tu modelo (ajusta al script correcto)
      # Puedes cambiar 'linear.py' por 'regression.py' o el que quieras probar.
      - name: Execute model
        run: python linear.py

      # 5Ô∏è‚É£ Mostrar estructura del proyecto
      - name: Show project structure
        run: ls -la

      # 6Ô∏è‚É£ Login a Docker Hub (usa tus secrets configurados en GitHub)
      - name: Docker login
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          docker login -u $DOCKER_USER -p $DOCKER_PASSWORD

      # 7Ô∏è‚É£ Descargar e iniciar contenedor base de TensorFlow Serving
      - name: Run TensorFlow Serving base container
        run: docker run -d --name serving_base tensorflow/serving

      # 8Ô∏è‚É£ Copiar tu modelo entrenado al contenedor
      # ‚ö†Ô∏è Aseg√∫rate que el modelo que quieras copiar exista localmente y est√© ignorado por .gitignore
      - name: Copy model to container
        run: docker cp ${{ secrets.MODEL_NAME }} serving_base:/models/${{ secrets.MODEL_NAME }}

      # 9Ô∏è‚É£ Construir imagen Docker personalizada con tu modelo
      - name: Build custom Docker image
        run: docker commit --change "ENV MODEL_NAME=${{ secrets.MODEL_NAME }}" serving_base ${{ secrets.DOCKER_USER }}/tensorflow-${{ secrets.MODEL_NAME }}:${{ github.sha }}

      # üîü Subir imagen a Docker Hub
      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_USER }}/tensorflow-${{ secrets.MODEL_NAME }}:${{ github.sha }}
